
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€æ˜“åˆ†é•œç¼–å†™å™¨</title>
    <style>
        /* --- é»‘æš—æ¨¡å¼å…¨å±€æ ·å¼ --- */
        html, body {
            height: 100%; 
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #1e1e1e;
            color: #cccccc;
            overflow: hidden; 
        }

        /* *** æ ‡é¢˜æ é‡å¡‘ *** */
        #global-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 15px;
            background-color: #252526;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
            position: relative;
            height: 50px;
        }

        /* æ ‡é¢˜å’Œä¸Šä¼ æŒ‰é’®çš„å®¹å™¨ */
        #title-and-upload {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #global-header h1 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 600;
            padding: 5px 0;
            cursor: pointer;
            transition: color 0.2s;
            color: #00ccff;
        }
        
        #global-header h1:hover {
            color: white;
        }

        /* ç»Ÿä¸€çš„å•è‰²å›¾æ ‡æŒ‰é’®æ ·å¼ */
        .icon-btn {
            background: none;
            border: none;
            color: #cccccc;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            opacity: 0.8;
            transition: opacity 0.2s, color 0.2s;
        }
        .icon-btn:hover:not(:disabled) {
            opacity: 1;
            color: #00ff7f;
        }
        .icon-btn:disabled {
            cursor: not-allowed;
            opacity: 0.3;
            color: #444;
        }
        
        /* ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶åæ˜¾ç¤º - å¯ç‚¹å‡»é‡æ–°ä¸Šä¼  */
        #audio-file-name-display {
            font-size: 0.9em;
            color: #00ff7f;
            background-color: #333337;
            padding: 5px 10px;
            border-radius: 4px;
            display: none;
            cursor: pointer; /* ä½¿æ–‡ä»¶åçœ‹èµ·æ¥å¯äº¤äº’ */
            border: 1px solid transparent;
            transition: border-color 0.2s;
        }
        #audio-file-name-display:hover {
            border-color: #00ff7f;
        }

        /* --- ä¸­é—´æ—¶é—´æŒ‡ç¤ºå™¨å’Œæ§åˆ¶å™¨ï¼ˆå±…ä¸­å®ç°ï¼‰ --- */
        #center-controls-wrapper {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            gap: 10px;
            height: 100%;
        }

        /* åˆ†é•œè®¡æ•°å™¨ */
        .counter-box {
            background-color: #333337;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #999;
            border: 1px solid #444; 
            white-space: nowrap;
        }
        
        .counter-box strong {
            color: #fff;
            margin-left: 5px;
        }

        /* æ—¶é—´æŒ‡ç¤ºå™¨å®¹å™¨ */
        #time-display-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #1e1e1e;
            border-radius: 6px;
            padding: 5px 10px;
            border: 1px solid #444; 
        }
        
        #time-display-bar {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 25px;
            font-family: monospace;
            font-size: 1.2em;
            font-weight: bold;
            color: #00ff7f; 
            user-select: none;
        }
        
        #current-time-display {
            text-align: right;
            padding-right: 5px;
        }
        
        #duration-display {
            text-align: left;
            color: #aaa; 
            font-size: 0.8em;
            padding-left: 5px;
        }
        
        #time-separator {
            color: #555;
            margin: 0 5px;
        }

        .unloaded-state {
            color: #888 !important;
            font-size: 1em !important;
            font-weight: normal !important;
            height: 25px;
            line-height: 25px;
        }

        /* åº•éƒ¨è¿›åº¦æ¡ */
        #playback-progress-bar-wrapper {
            width: 100%;
            height: 3px;
            background-color: #555;
            border-radius: 2px;
            margin-top: 3px;
            overflow: hidden;
        }
        
        #playback-progress-bar {
            height: 100%;
            width: 0%;
            background-color: #00ff7f;
        }
        
        /* --- å¯¼å‡ºæŒ‰é’®å’Œæ›´å¤šæŒ‰é’®åŒºåŸŸ --- */
        #right-corner-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .export-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        .export-btn:hover {
            background-color: #218838;
        }

        /* æ›´å¤šæŒ‰é’® (...) æ ·å¼ */
        #more-options-btn {
            padding: 8px 10px;
            background-color: #333337;
            color: #ccc;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            line-height: 1;
            transition: background-color 0.2s;
        }
        #more-options-btn:hover {
            background-color: #444448;
        }
        
        /* æ›´å¤šé€‰é¡¹ä¸‹æ‹‰èœå• */
        #more-options-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background-color: #2d2d30;
            border: 1px solid #444;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            padding: 5px 0;
            min-width: 150px;
            display: none;
        }

        #more-options-menu button {
            display: block;
            width: 100%;
            padding: 8px 15px;
            text-align: left;
            background: none;
            border: none;
            color: #cccccc;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.1s;
        }

        #more-options-menu button:hover {
            background-color: #3c3c3c;
        }

        #clear-all-scenes-btn {
            color: #e76c78;
        }
        
        /* --- é¡µé¢ä¸»ä½“å’Œè¡¨æ ¼æ ·å¼ --- */
        #app-container {
            display: flex;
            height: calc(100vh - 60px); 
            padding: 10px;
            gap: 10px;
            box-sizing: border-box;
            
            /* é»˜è®¤çŠ¶æ€ï¼šå®½åº¦ 100% ç´§è´´é¡µé¢ä¸¤ç«¯ */
            width: 100%;
        }
        
        /* åª’ä½“æŸ¥è¯¢ï¼šå½“è§†å£å®½åº¦å¤§äºæˆ–ç­‰äº 1250px æ—¶ */
        @media (min-width: 1250px) {
            #app-container {
                /* å®½åº¦ä¿æŒ 1250px */
                width: 1250px;
                /* å±…ä¸­ */
                margin: 0 auto;
            }
        }
        /* --- åª’ä½“æŸ¥è¯¢ç»“æŸ --- */

        #storyboard-container { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            background-color: #2d2d30;
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); 
            overflow: hidden; 
        }
        #controls-header { 
            padding: 10px 15px; 
            border-bottom: 1px solid #3c3c3c; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background-color: #2d2d30;
        }
        #controls-header span { font-size: 0.9em; color: #999; }
        #table-scroll-wrapper { flex-grow: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; color: #cccccc; }
        
        /* è¡¨å¤´æ ·å¼ - ä¿æŒä¸å˜ä»¥ç¡®ä¿é«˜åº¦ä¸å˜ */
        th { 
            background-color: #333337; 
            position: sticky; 
            top: 0; 
            z-index: 2; 
            color: #fff;
            padding: 10px 0; /* æ§åˆ¶è¡¨å¤´é«˜åº¦çš„å…³é”® */
            border-bottom: 1px solid #444;
            vertical-align: middle;
        }
        
        tr { 
            border-bottom: 5px solid #1e1e1e;
            transition: background-color 0.2s; 
            cursor: grab; 
        }
        tr.dragging { opacity: 0.5; transform: scale(1.01); background-color: #4a412a !important; }
        tr.drag-over { border-top: 2px solid #007bff; }
        tr:hover { background-color: #38383a; }
        .highlight-row { background-color: #4a412a !important; }
        td { border: none; padding: 0; vertical-align: top; }
        
        /* --- æ ¸å¿ƒå¸ƒå±€ä¿®æ­£ --- */
        
        /* 1. æ›´æ–°åˆ—å®½åº¦ (TH å’Œ TD å…±äº«æ­¤å®½åº¦) */
        .handle-cell { 
            width: 30px; 
            text-align: center; 
            vertical-align: middle; 
            padding: 5px 0; 
            background-color: #3c3c3c; 
            cursor: grab; 
        }

        .image-cell { 
            width: 300px; /* å›ºå®šå®½åº¦ */
            padding: 10px; 
        }

        .text-cell { 
            width: calc(100% - 30px - 300px); 
            padding: 10px; 
        }
        
        /* 2. TD ä¸“å±çš„é«˜åº¦é€‚é… FIX: å¯ç”¨ Flexbox */
        td.image-cell {
            display: flex; /* ä½¿ TD æˆä¸º Flex å®¹å™¨ */
            flex-direction: column; /* å‚ç›´æ’åˆ— */
            height: 100%; /* ç¡®ä¿ TD ç»§æ‰¿ TR çš„é«˜åº¦ */
            align-items: center; 
            justify-content: center;
        }

        /* 3. æ§åˆ¶è¡Œæœ€å°é«˜åº¦å’Œæ–‡æœ¬åŒºåŸŸçš„å‚ç›´å¯¹é½ */
        .text-cell-wrapper {
            min-height: 160px; /* æ§åˆ¶è¡Œå†…å®¹çš„æœ€å°é«˜åº¦ (~180px æ€»è¡Œé«˜) */
            display: flex;
            flex-direction: column;
        }

        /* 4. å›¾ç‰‡ä¸Šä¼ æ¡†å¼¹æ€§å¡«å……é«˜åº¦ */
        .image-upload-box { 
            position: relative; 
            width: 100%; 
            flex-grow: 1; /* å…³é”®ï¼šå…è®¸å®ƒå¡«å…… TD çš„å‰©ä½™é«˜åº¦ */
            min-height: 172px; /* ç¡®ä¿åœ¨æ— æ–‡æœ¬æ—¶æœ‰æœ€ä½é«˜åº¦ */
            
            /* å…¶ä»–æ ·å¼ä¿æŒä¸å˜ */
            padding-top: 0; 
            background-color: #333337;
            border: 2px dashed #666; 
            border-radius: 4px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #666; 
            font-size: 2em; 
            overflow: hidden; 
            transition: border-color 0.2s; 
        }

        .image-upload-box input[type="file"] { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; 
        }
        
        .image-preview-container { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            display: none; 
            overflow: hidden;
            display: flex; 
            align-items: center; 
            justify-content: center;
        }

        .uploaded-img { 
            width: auto;
            height: 100%; /* é«˜åº¦å……æ»¡ image-upload-box */
            object-fit: contain;
            display: block; 
        }
        
        /* --- å…¶ä»–æ ·å¼ä¿æŒä¸å˜ --- */
        .text-area {
            flex-grow: 1;
            min-height: 80px; 
            width: 100%;
            border: 1px solid #555;
            background-color: #3c3c3c;
            color: #cccccc;
            padding: 8px;
            box-sizing: border-box;
            resize: none; 
            font-size: 14px;
            line-height: 1.4;
            border-radius: 4px;
            margin-top: 5px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }
        .text-area::placeholder { color: #999; }
        
        .delete-btn { background: none; border: none; color: #e76c78; font-size: 1.1em; cursor: pointer; padding: 3px; opacity: 0.7; transition: opacity 0.2s; display: block; margin: 0 auto 5px auto; }
        .delete-btn:hover { opacity: 1; }
        
        .image-upload-box:hover, .image-upload-box.drag-target { border-color: #0099ff; color: #0099ff; }
        
        #timeline-panel { 
            width: 60px; display: flex; flex-direction: column; 
            background-color: #2d2d30;
            border-radius: 8px; padding: 15px 5px; 
        }
        #timeline-wrapper { flex-grow: 1; position: relative; }
        #timeline-progress { width: 4px; height: 100%; position: absolute; left: 50%; transform: translateX(-50%); top: 0; background-color: #666; }
        .timeline-marker { position: absolute; left: -8px; width: 20px; height: 2px; background-color: #ffc107; border-radius: 2px; cursor: default; z-index: 10; }
        #playback-cursor { position: absolute; left: -12px; width: 30px; height: 5px; background-color: #dc3545; z-index: 100; transform: translateY(-50%); border-radius: 4px; cursor: grab; }
        
    </style>
</head>
<body>

    <div id="global-header">
        <div id="title-and-upload">
            <h1 onclick="showShortcutHint()">ğŸ¬ åˆ†é•œç¼–å†™å™¨</h1>
            
            <input type="file" id="audioFile" accept="audio/*" onchange="loadAudioDuration(this)" style="display:none;">
            
            <button class="icon-btn" id="uploadAudioBtn" onclick="document.getElementById('audioFile').click()" title="ä¸Šä¼ éŸ³é¢‘">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="white"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8" />
              <polyline points="16 6 12 2 8 6" />
              <line x1="12" y1="2" x2="12" y2="15" />
            </svg>
        </button>
            <span id="audio-file-name-display" onclick="reuploadAudio()"></span>
        </div>

        <div id="center-controls-wrapper">
            <div class="counter-box">
                åˆ†é•œæ•°: <strong id="scene-counter">0</strong>
            </div>
            
            <div id="time-display-container">
                <div id="time-display-bar">
                    <span id="current-time-display" class="unloaded-state">ä¸Šä¼ æ–‡ä»¶å¼€å§‹ç¼–è¾‘</span>
                    <span id="time-separator" style="display:none;">|</span>
                    <span id="duration-display" style="display:none;"></span>
                </div>
                <div id="playback-progress-bar-wrapper">
                     <div id="playback-progress-bar"></div>
                </div>
            </div>
            
            <button class="icon-btn" id="playPauseBtn" onclick="togglePlayback()" disabled>â—¼</button>
        </div>
        
        <div id="right-corner-controls">
            <button id="more-options-btn" onclick="toggleMoreMenu()">Â·Â·Â·</button>

            <div id="more-options-menu">
                <button id="import-csv-btn" onclick="document.getElementById('csvFileInput').click()">ğŸ“¥ å¯¼å…¥ CSV</button>
                <button id="clear-all-scenes-btn" onclick="clearAllScenes()">âš ï¸ æ¸…é™¤å…¨éƒ¨åˆ†é•œ</button>
            </div>
            
            <button class="export-btn" onclick="exportToCSV()">ğŸ’¾ å¯¼å‡º CSV</button>
        </div>
        
        <input type="file" id="csvFileInput" accept=".csv" style="display:none;" onchange="loadCSV(this.files[0])">
        <audio id="audioPlayer" style="display:none;"></audio>
    </div>

    <div id="app-container">
        
        <div id="storyboard-container">
            <div id="controls-header">
                <span>æ‹–åŠ¨ä»¥è¡Œè¿›è¡Œæ’åº</span>
                <button class="add-row-btn" onclick="addRow(null, null, true)">â• æ·»åŠ æ— æ—¶é—´åˆ†é•œ</button>
            </div>
            
            <div id="table-scroll-wrapper">
                <table id="storyboard-table">
                    <thead>
                        <tr>
                            <th class="handle-cell">#</th>
                            <th class="image-cell">å›¾åƒ</th>
                            <th class="text-cell">æè¿°/è„šæœ¬</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div id="timeline-panel">
            <div id="timeline-wrapper">
                <div id="timeline-progress">
                    <div id="playback-cursor" style="top: 0%;"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- JavaScript é€»è¾‘éƒ¨åˆ† ---
        const tableBody = document.querySelector('#storyboard-table tbody');
        const timelineProgress = document.getElementById('timeline-progress');
        const playbackCursor = document.getElementById('playback-cursor');
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        
        const currentTimeDisplay = document.getElementById('current-time-display');
        const durationDisplay = document.getElementById('duration-display');
        const timeSeparator = document.getElementById('time-separator');
        const progressBar = document.getElementById('playback-progress-bar');
        const sceneCounter = document.getElementById('scene-counter');
        
        const uploadAudioBtn = document.getElementById('uploadAudioBtn');
        const audioFileNameDisplay = document.getElementById('audio-file-name-display');
        const moreOptionsMenu = document.getElementById('more-options-menu');
        
        let markers = []; 
        let nextRowId = 1;
        let totalDuration = 0; 
        let isDragging = false;
        let timelineRect;
        let draggedRow = null;
        let animationFrameId = null;
        
        function formatTime(seconds) {
            const totalCs = Math.round(seconds * 100); 
            const cs = (totalCs % 100).toString().padStart(2, '0');
            const totalS = Math.floor(totalCs / 100);
            const min = Math.floor(totalS / 60);
            const sec = (totalS % 60).toString().padStart(2, '0');
            return `${min}:${sec}.${cs}`;
        }
        
        window.showShortcutHint = function() {
            alert(
                "ğŸ¹ å¿«æ·é”®æç¤º\n\n" +
                "ç©ºæ ¼é”®: æ’­æ”¾/æš‚åœ\n" +
                "M é”®: åœ¨å½“å‰éŸ³é¢‘æ—¶é—´ç‚¹æ·»åŠ æ–°çš„åˆ†é•œæ ‡è®°\n" +
                "1 é”®: å°†éŸ³é¢‘æ’­æ”¾å¤´å½’é›¶\n" +
                "Delete é”®: åˆ é™¤å½“å‰é«˜äº®åˆ†é•œ\n" +
                "/ é”®: è·³è½¬åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´æ ‡è®°\n" +
                "* é”®: è·³è½¬åˆ°ä¸Šä¸€ä¸ªæ—¶é—´æ ‡è®°\n" +
                "Esc é”®: é€€å‡ºæ–‡å­—ç¼–è¾‘\n\n" +
                "*æ³¨ï¼šåœ¨ç¼–å†™æ–‡å­—çš„æ—¶å€™ï¼Œã€Œ/ã€é”®ä¸ã€Œ*ã€é”®ä¸å¯ç”¨"
            );
        }
        
        window.toggleMoreMenu = function() {
            moreOptionsMenu.style.display = moreOptionsMenu.style.display === 'block' ? 'none' : 'block';
        }
        
        document.addEventListener('click', function(event) {
            const moreBtn = document.getElementById('more-options-btn');
            if (moreOptionsMenu.style.display === 'block' && 
                event.target !== moreOptionsMenu && 
                event.target !== moreBtn &&
                !moreOptionsMenu.contains(event.target)) {
                
                moreOptionsMenu.style.display = 'none';
            }
        });

        window.reuploadAudio = function() {
            document.getElementById('audioFile').click();
        }

        /**
         * æ£€æŸ¥å¹¶åˆ é™¤æ‰€æœ‰è¶…å‡ºæ–°éŸ³é¢‘æ—¶é•¿çš„åˆ†é•œæ ‡è®°å’Œè¡¨æ ¼è¡Œã€‚
         * @param {number} newDuration æ–°éŸ³é¢‘çš„æ—¶é•¿
         */
        function pruneMarkers(newDuration) {
            const markersToDelete = markers.filter(m => m.time > newDuration);
            
            if (markersToDelete.length > 0) {
                console.warn(`âœ‚ï¸ éŸ³é¢‘å˜çŸ­ï¼Œè£å‰ªäº† ${markersToDelete.length} ä¸ªè¶…å‡ºæ–°æ—¶é•¿çš„åˆ†é•œæ ‡è®°ã€‚`);
                
                // ä¸ºäº†é¿å…ä¿®æ”¹ markers æ•°ç»„æ—¶å‡ºé”™ï¼Œéå†å‰¯æœ¬å¹¶è°ƒç”¨ deleteRow
                markersToDelete.forEach(marker => {
                    // deleteRow ä¼šä» markers ä¸­ç§»é™¤æ ‡è®°ï¼Œä» DOM ä¸­ç§»é™¤è¡Œå’Œæ ‡è®°ï¼Œå¹¶æ›´æ–°è®¡æ•°ã€‚
                    deleteRow(marker.rowId); 
                });
            }
        }

        window.clearAllScenes = function() {
            
            moreOptionsMenu.style.display = 'none';
            audioPlayer.pause();
            stopPlaybackLoop();
            
            markers = []; 
            tableBody.innerHTML = '';
            timelineProgress.querySelectorAll('.timeline-marker').forEach(m => m.remove());
            nextRowId = 1;
            sceneCounter.textContent = '0';
            
            if (totalDuration > 0) {
                 audioPlayer.currentTime = 0;
                 updatePlaybackUI();
            }
            
            console.log('âœ… æ‰€æœ‰åˆ†é•œå·²æ¸…é™¤ï¼ŒéŸ³é¢‘ä¿¡æ¯ä¿ç•™ã€‚');
        }

        window.exportToCSV = function() {
            const rows = tableBody.querySelectorAll('tr');
            const BOM = "\uFEFF"; 
            let csvContent = BOM;
            csvContent += "åºå·,æ—¶é—´ç‚¹,æè¿°/è„šæœ¬,å›¾åƒæ–‡ä»¶å\r\n";
            rows.forEach((row, index) => {
                const rowId = row.id.replace('row-', '');
                const timeInfoElement = row.querySelector('.marker-info');
                let rawTime = timeInfoElement ? timeInfoElement.textContent.match(/[\d\.]+/)?.[0] : '';
                let time = rawTime ? parseFloat(rawTime).toFixed(2) : ''; 
                
                const descriptionElement = row.querySelector('.text-area');
                let description = descriptionElement ? descriptionElement.value : '';
                
                // 1. æ›¿æ¢æ‰€æœ‰åŒå¼•å·ä¸ºåŒåŒå¼•å· (Excel/CSV æ ‡å‡†è½¬ä¹‰)
                // 2. æ›¿æ¢æ‰€æœ‰æ¢è¡Œç¬¦ä¸ºå•ä¸ªç©ºæ ¼
                description = description.replace(/"/g, '""').replace(/\r?\n|\r/g, ' ').trim(); 
                // 3. ç¡®ä¿å­—æ®µè¢«åŒå¼•å·åŒ…è£¹
                let quotedDescription = `"${description}"`; 

                const imageFileElement = row.querySelector(`#image-file-name-${rowId}`);
                let imageFileName = imageFileElement ? imageFileElement.textContent : '';
                
                // ç¡®ä¿å›¾åƒæ–‡ä»¶åä¹Ÿè¢«åŒå¼•å·åŒ…è£¹ï¼Œä»¥é˜²æ–‡ä»¶åä¸­å«æœ‰é€—å·
                let quotedImageFileName = `"${imageFileName.replace(/"/g, '""')}"`;

                csvContent += `${index + 1},${time},${quotedDescription},${quotedImageFileName}\r\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `åˆ†é•œè„šæœ¬_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.loadCSV = function(file) {
            if (!file) return;

            // æ¸…é™¤ç°æœ‰çš„åˆ†é•œå’Œæ ‡è®°ï¼Œä½†ä¿ç•™éŸ³é¢‘
            clearAllScenes();
            nextRowId = 1; // ç¡®ä¿ä»1å¼€å§‹è®¡æ•°æ–°å¯¼å…¥çš„è¡Œ

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                try {
                    const rows = parseCSV(csvText); // è§£æ CSV æ–‡æœ¬
                    if (rows.length > 1) { // è‡³å°‘è¦æœ‰ä¸€è¡Œæ•°æ® (è¡¨å¤´ + 1è¡Œ)
                        // è·³è¿‡è¡¨å¤´ (å‡è®¾ç¬¬ä¸€è¡Œæ˜¯è¡¨å¤´)
                        for (let i = 1; i < rows.length; i++) {
                            const rowData = rows[i];
                            
                            // CSV å­—æ®µå¯¹åº”ï¼šåºå·(0),æ—¶é—´ç‚¹(1),æè¿°/è„šæœ¬(2),å›¾åƒæ–‡ä»¶å(3)
                            const timeString = rowData[1] ? rowData[1].trim() : '';
                            const description = rowData[2] ? rowData[2].trim() : '';
                            
                            let time = null;
                            let percent = null;
                            
                            if (timeString && totalDuration > 0) {
                                // åªæœ‰éŸ³é¢‘åŠ è½½å®Œæˆåï¼Œæ‰èƒ½å¯¼å…¥å¸¦æ—¶é—´çš„åˆ†é•œ
                                time = parseFloat(timeString);
                                if (!isNaN(time) && time >= 0 && time <= totalDuration) {
                                    percent = time / totalDuration;
                                } else {
                                    time = null; // æ—¶é—´æ— æ•ˆæˆ–è¶…å‡ºæ—¶é•¿ï¼ŒæŒ‰æ— æ—¶é—´æ ‡è®°å¤„ç†
                                }
                            }

                            // åˆ›å»ºæ–°è¡Œã€‚å›¾åƒæ–‡ä»¶å (rowData[3]) æ— æ³•ç›´æ¥åŠ è½½ï¼Œåªä¿ç•™å­—æ®µ
                            addRow(time, percent, time === null); 
                            
                            // å¡«å……æè¿°/è„šæœ¬
                            const newRow = document.getElementById(`row-${nextRowId - 1}`);
                            if (newRow) {
                                const textArea = newRow.querySelector('.text-area');
                                if (textArea) {
                                    textArea.value = description;
                                }
                                
                                // é¢„ç•™å›¾åƒæ–‡ä»¶åä¿¡æ¯ï¼ˆæ— æ³•è‡ªåŠ¨åŠ è½½å›¾ç‰‡ï¼Œä½†ä¿ç•™ä¿¡æ¯ä¾›å¯¼å‡ºæ—¶ä½¿ç”¨ï¼‰
                                const imageFileNameSpan = newRow.querySelector(`#image-file-name-${nextRowId - 1}`);
                                if (imageFileNameSpan && rowData[3]) {
                                    imageFileNameSpan.textContent = rowData[3].trim();
                                }
                            }
                        }
                        console.log(`âœ… æˆåŠŸå¯¼å…¥ ${rows.length - 1} ä¸ªåˆ†é•œã€‚`);
                    } else {
                        alert('å¯¼å…¥å¤±è´¥ï¼šCSV æ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚');
                    }
                } catch (error) {
                    console.error('CSV è§£æé”™è¯¯:', error);
                    alert('å¯¼å…¥å¤±è´¥ï¼šCSV æ–‡ä»¶è§£æå‡ºé”™ã€‚è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚');
                }
            };
            // ä½¿ç”¨ 'utf-8' ç¼–ç ï¼Œä»¥æ­£ç¡®å¤„ç† BOM å’Œä¸­æ–‡
            reader.readAsText(file, 'utf-8'); 
            
            // éšè—èœå•
            toggleMoreMenu();
        };

        /**
         * ç®€å•çš„ CSV è§£æå™¨ï¼Œæ”¯æŒåŒå¼•å·å’Œ BOMã€‚
         * @param {string} text CSV åŸå§‹æ–‡æœ¬ã€‚
         * @returns {Array<Array<string>>} è§£æåçš„è¡Œå’Œåˆ—æ•°ç»„ã€‚
         */
        function parseCSV(text) {
            // ç§»é™¤ BOM (Byte Order Mark)
            if (text.charCodeAt(0) === 0xFEFF) {
                text = text.substr(1);
            }
            
            const lines = text.split(/\r\n|\n|\r/);
            const result = [];
            
            for (const line of lines) {
                if (line.trim() === '') continue;

                const values = [];
                let currentValue = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
                            // Escaped quote: "" -> "
                            currentValue += '"';
                            i++; 
                        } else {
                            // Toggle quote state
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // End of a field
                        values.push(currentValue);
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                // Push the last field
                values.push(currentValue); 

                // æ¸…ç†å¹¶å¤„ç†å€¼ (ç§»é™¤å­—æ®µé¦–å°¾å¯èƒ½å­˜åœ¨çš„å¤šä½™åŒå¼•å·å’Œç©ºç™½)
                const cleanedValues = values.map(val => val.trim().replace(/^"|"$/g, ''));
                result.push(cleanedValues);
            }
            
            return result;
        }


        function updatePlaybackUI() {
            if (totalDuration > 0) {
                const currentTime = audioPlayer.currentTime;
                const percent = currentTime / totalDuration;
                
                currentTimeDisplay.textContent = formatTime(currentTime);
                progressBar.style.width = `${percent * 100}%`;
                updateCursorPosition(percent);
                highlightCurrentRow(currentTime);
            }
            
            if (!audioPlayer.paused && audioPlayer.currentTime < totalDuration) {
                animationFrameId = requestAnimationFrame(updatePlaybackUI);
            } else {
                 animationFrameId = null;
            }
        }
        
        function startPlaybackLoop() {
            if (!animationFrameId && !audioPlayer.paused && totalDuration > 0) {
                animationFrameId = requestAnimationFrame(updatePlaybackUI);
            }
        }

        function stopPlaybackLoop() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }

        window.loadAudioDuration = function(input) {
            if (input.files.length === 0) return;
            const file = input.files[0];
            
            const isReUpload = totalDuration > 0; // æ£€æŸ¥æ˜¯å¦ä¸ºé‡æ–°ä¸Šä¼ 
            const oldDuration = totalDuration;
            
            if (!isReUpload) {
                // é¦–æ¬¡åŠ è½½ï¼Œéœ€è¦æ¸…é™¤é»˜è®¤çŠ¶æ€
                resetEditor(); 
            } else {
                // é‡æ–°ä¸Šä¼ æ—¶ï¼Œåœæ­¢æ’­æ”¾
                audioPlayer.pause();
                stopPlaybackLoop();
            }

            const fileNameWithoutExtension = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
            audioFileNameDisplay.textContent = fileNameWithoutExtension;
            audioFileNameDisplay.style.display = 'block';
            uploadAudioBtn.style.display = 'none';

            const fileURL = URL.createObjectURL(file);
            audioPlayer.src = fileURL;

            audioPlayer.onloadedmetadata = function() {
                if (audioPlayer.duration && isFinite(audioPlayer.duration)) {
                    totalDuration = audioPlayer.duration; // æ›´æ–°æ€»æ—¶é•¿
                    
                    // è£å‰ªæ ‡è®°é€»è¾‘ï¼šå¦‚æœéŸ³é¢‘å˜çŸ­
                    if (isReUpload && totalDuration < oldDuration) {
                        pruneMarkers(totalDuration); 
                    }
                    
                    // ç¡®ä¿æ’­æ”¾å¤´åœ¨æ–°æ—¶é•¿èŒƒå›´å†…
                    if (audioPlayer.currentTime > totalDuration) {
                        audioPlayer.currentTime = totalDuration;
                    }

                    currentTimeDisplay.classList.remove('unloaded-state');
                    currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);
                    durationDisplay.textContent = formatTime(totalDuration);
                    durationDisplay.style.display = 'block';
                    timeSeparator.style.display = 'block';
                    progressBar.style.width = `${audioPlayer.currentTime / totalDuration * 100}%`;

                    playPauseBtn.disabled = false;
                    updateCursorPosition(audioPlayer.currentTime / totalDuration);

                    // éœ€è¦é‡æ–°è®¡ç®—å¹¶ç»˜åˆ¶æ‰€æœ‰æ ‡è®°çš„ä½ç½®ï¼Œå› ä¸ºæ€»æ—¶é•¿å˜äº†
                    markers.forEach(m => {
                        m.percent = m.time / totalDuration;
                        const markerDiv = timelineProgress.querySelector(`.timeline-marker[data-row-id="${m.rowId}"]`);
                        if(markerDiv) {
                            markerDiv.style.top = `${m.percent * 100}%`;
                        }
                    });
                    
                } else {
                    currentTimeDisplay.textContent = 'âŒ æ— æ³•è¯»å–éŸ³é¢‘æ—¶é•¿ã€‚';
                    resetEditorState(true);
                }
            };
            audioPlayer.onerror = function() {
                currentTimeDisplay.textContent = 'âŒ éŸ³é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥ã€‚';
                resetEditorState(true); 
            }
            
            audioPlayer.ontimeupdate = null; 
        }
        
        function resetEditorState(disableTimeline = false) {
            stopPlaybackLoop(); 
            
            playPauseBtn.textContent = 'â–¶';
            playPauseBtn.disabled = true;
            progressBar.style.width = '0%';
            
            if (disableTimeline) {
                totalDuration = 0;
                markers = []; 
                tableBody.innerHTML = '';
                timelineProgress.querySelectorAll('.timeline-marker').forEach(m => m.remove());
                nextRowId = 1;
                sceneCounter.textContent = '0';
                
                audioFileNameDisplay.style.display = 'none';
                uploadAudioBtn.style.display = 'block';
                
                currentTimeDisplay.textContent = 'ä¸Šä¼ æ–‡ä»¶å¼€å§‹ç¼–è¾‘';
                currentTimeDisplay.classList.add('unloaded-state');
                durationDisplay.style.display = 'none';
                timeSeparator.style.display = 'none';
            }
        }
        
        function resetEditor(disableTimeline = false) {
            resetEditorState(disableTimeline);
        }


        function togglePlayback() {
            if (audioPlayer.paused || audioPlayer.ended) {
                audioPlayer.play();
                startPlaybackLoop();
            } else {
                audioPlayer.pause();
                stopPlaybackLoop();
            }
        }

        function seekToStart() {
            if (totalDuration > 0) {
                audioPlayer.currentTime = 0;
                audioPlayer.pause(); 
                stopPlaybackLoop();
                playPauseBtn.textContent = 'â–¶';
                updatePlaybackUI();
            }
        }

        audioPlayer.addEventListener('play', () => { 
            playPauseBtn.textContent = 'â—¼'; 
            startPlaybackLoop();
        });
        audioPlayer.addEventListener('pause', () => { 
            if (!isDragging) {
                playPauseBtn.textContent = 'â–¶';
            }
        });
        
        audioPlayer.addEventListener('ended', () => {
            stopPlaybackLoop();
            updatePlaybackUI();
            playPauseBtn.textContent = 'â–¶';
            document.querySelectorAll('.highlight-row').forEach(row => row.classList.remove('highlight-row'));
        });


        function updateCursorPosition(percent) {
            const clampedPercent = Math.min(1.0, Math.max(0.0, percent));
            playbackCursor.style.top = `${clampedPercent * 100}%`;
        }
        
        function highlightCurrentRow(currentTime) {
            const activeMarkers = markers
                .filter(m => m.time <= currentTime)
                .sort((a, b) => b.time - a.time); 

            document.querySelectorAll('.highlight-row').forEach(row => row.classList.remove('highlight-row'));

            if (activeMarkers.length > 0) {
                const rowToHighlight = document.getElementById(`row-${activeMarkers[0].rowId}`);
                if (rowToHighlight) {
                    rowToHighlight.classList.add('highlight-row');
                    const tableWrapper = document.getElementById('table-scroll-wrapper');
                    const rowRect = rowToHighlight.getBoundingClientRect();
                    const wrapperRect = tableWrapper.getBoundingClientRect();

                    if (rowRect.bottom > wrapperRect.bottom || rowRect.top < wrapperRect.top) {
                         rowToHighlight.scrollIntoView({ behavior: 'auto', block: 'center' });
                    }
                }
            }
        }

        playbackCursor.addEventListener('mousedown', (e) => {
            if (totalDuration === 0) return;
            isDragging = true;
            stopPlaybackLoop();
            timelineRect = timelineProgress.getBoundingClientRect(); 
            audioPlayer.pause(); 
            playPauseBtn.textContent = 'â–¶';
            e.preventDefault(); 
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging || totalDuration === 0) return;
            let newY = e.clientY - timelineRect.top;
            newY = Math.max(0, Math.min(timelineRect.height, newY));
            const percent = newY / timelineRect.height;
            const newTime = percent * totalDuration;
            
            audioPlayer.currentTime = newTime; 
            
            currentTimeDisplay.textContent = formatTime(newTime);
            progressBar.style.width = `${percent * 100}%`;
            updateCursorPosition(percent);
            highlightCurrentRow(newTime);
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
            }
        });

        document.addEventListener('keydown', (e) => {
            const activeElement = document.activeElement;
            const isInputActive = activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'INPUT';
            
            // 1. å¦‚æœæŒ‰ä¸‹çš„æ˜¯ Esc é”®
            if (e.key === 'Escape') {
                if (isInputActive) {
                    // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†/æ–‡æœ¬åŒºï¼Œåˆ™è®©å…¶å¤±å»ç„¦ç‚¹ (é€€å‡ºç¼–è¾‘)
                    activeElement.blur(); 
                    e.preventDefault(); // é˜»æ­¢æµè§ˆå™¨å¯èƒ½çš„é»˜è®¤è¡Œä¸º
                    return;
                }
                
                // å¦‚æœæ›´å¤šèœå•æ‰“å¼€ç€ï¼ŒæŒ‰ Esc å…³é—­å®ƒ
                if (moreOptionsMenu.style.display === 'block') {
                     toggleMoreMenu();
                     e.preventDefault();
                     return;
                }
            }
            
            // 2. å¦‚æœç”¨æˆ·æ­£åœ¨è¾“å…¥æ¡†/æ–‡æœ¬åŒºæ‰“å­— (éEscé”®)
            if (isInputActive) {
                // å…è®¸ Delete/Backspace åœ¨æ–‡æœ¬åŒºåŸŸå†…æ­£å¸¸æ“ä½œ
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    return; 
                }
                // é˜»æ­¢ / å’Œ * è§¦å‘å¯¼èˆª
                if (e.key === '/' || e.key === '*') {
                     e.preventDefault();
                     return;
                }
                return; // å¿½ç•¥å…¶ä»–å¿«æ·é”®
            }
            
            // 3. å…¨å±€çƒ­é”®å¤„ç†
            if (totalDuration === 0 && e.key !== 'Delete') { return; }

            switch (e.key) {
                case ' ': 
                    e.preventDefault(); 
                    togglePlayback(); 
                    break;
                case 'm': 
                case 'M':
                    e.preventDefault(); 
                    const currentTime = audioPlayer.currentTime;
                    const percent = currentTime / totalDuration;
                    const isTooClose = markers.some(m => Math.abs(m.time - currentTime) < 0.5); 
                    if (isTooClose) { console.log('æ³¨æ„ï¼šè¯¥ä½ç½®é™„è¿‘å·²æœ‰æ ‡è®°ã€‚'); }
                    addRow(currentTime, percent);
                    break;
                case '1': 
                case 'Numpad1': 
                    e.preventDefault(); 
                    seekToStart(); 
                    break;
                
                // --- å¿«æ·é”®åŠŸèƒ½ ---
                case 'Delete': 
                    e.preventDefault();
                    const highlightedRow = document.querySelector('.highlight-row');
                    if (highlightedRow) {
                        const rowId = highlightedRow.id.replace('row-', '');
                        deleteRow(parseInt(rowId));
                    }
                    break;
                    
                case '/': // ä¸‹ä¸€ä¸ªæ ‡è®°
                    e.preventDefault();
                    if (totalDuration === 0) return;
                    const nextMarker = markers.find(m => m.time > audioPlayer.currentTime + 0.001); 
                    
                    if (nextMarker) {
                        audioPlayer.currentTime = nextMarker.time;
                    } else {
                         audioPlayer.currentTime = totalDuration;
                    }
                    updatePlaybackUI(); 
                    break;
                    
                case '*': // ä¸Šä¸€ä¸ªæ ‡è®°
                    e.preventDefault();
                    if (totalDuration === 0) return;
                    
                    const prevMarkers = markers.filter(m => m.time < audioPlayer.currentTime - 0.001); 
                    
                    if (prevMarkers.length > 0) {
                        const prevMarker = prevMarkers[prevMarkers.length - 1];
                        audioPlayer.currentTime = prevMarker.time;
                    } else {
                        audioPlayer.currentTime = 0;
                    }
                    updatePlaybackUI();
                    break;
            }
        });

        window.deleteRow = function(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (row) {
                row.remove();
                const marker = timelineProgress.querySelector(`.timeline-marker[data-row-id="${rowId}"]`);
                if (marker) { marker.remove(); }
                // ä» markers æ•°ç»„ä¸­åˆ é™¤
                markers = markers.filter(m => m.rowId !== rowId); 
            }
            // ç¡®ä¿æ›´æ–°åˆ†é•œæ•°
            sceneCounter.textContent = tableBody.querySelectorAll('tr').length;
        }

        window.addRow = function(time = null, percent = null, noMarker = false) {
            const rowId = nextRowId++;
            
            const newRow = tableBody.insertRow();
            newRow.id = `row-${rowId}`;
            newRow.setAttribute('draggable', true); 

            const handleCell = newRow.insertCell();
            handleCell.className = 'handle-cell';
            handleCell.innerHTML = `<button class="delete-btn" onclick="deleteRow(${rowId})" title="åˆ é™¤æ­¤è¡Œ">ğŸ—‘ï¸</button>`;

            const imageCell = newRow.insertCell();
            imageCell.className = 'image-cell';
            const imageUploadBoxHtml = `
                <div class="image-upload-box" 
                     ondragover="handleImageDragOver(event, this)" 
                     ondragleave="handleImageDragLeave(event, this)" 
                     ondrop="handleImageDrop(event, ${rowId}, this)">
                    <input type="file" accept="image/*" onchange="previewImage(this.files[0], ${rowId})">
                    <span class="upload-icon">+</span>
                    <div id="image-preview-container-${rowId}" class="image-preview-container">
                        <img id="image-preview-${rowId}" class="uploaded-img">
                    </div>
                </div>
                <span id="image-file-name-${rowId}" style="display:none;"></span>
            `;
            imageCell.innerHTML = imageUploadBoxHtml;

            const textCell = newRow.insertCell();
            textCell.className = 'text-cell';
            const timeDisplay = time !== null ? `â± ${time.toFixed(2)}s` : '[æ— æ ‡è®°]';
            textCell.innerHTML = `
                <div class="text-cell-wrapper">
                    <p class="marker-info" id="row-marker-info-${rowId}">${timeDisplay}</p>
                    <textarea class="text-area" placeholder="è¾“å…¥åˆ†é•œæè¿°æˆ–è„šæœ¬..." rows="5"></textarea>
                </div>
            `;
            
            if (time !== null && percent !== null && !noMarker) {
                createTimelineMarker(rowId, time, percent);
            }
            
            newRow.addEventListener('dragstart', handleDragStart);
            newRow.addEventListener('dragover', handleDragOver);
            newRow.addEventListener('dragleave', handleDragLeave);
            newRow.addEventListener('drop', handleDrop);
            newRow.addEventListener('dragend', handleDragEnd);

            newRow.scrollIntoView({ behavior: 'auto', block: 'end' });
            
            sceneCounter.textContent = tableBody.querySelectorAll('tr').length;
        }
        
        window.previewImage = function(file, rowId) {
            if (!file) return;

            const previewContainer = document.getElementById(`image-preview-container-${rowId}`);
            const preview = document.getElementById(`image-preview-${rowId}`);
            const fileNameSpan = document.getElementById(`image-file-name-${rowId}`);
            
            const uploadBox = preview.closest('.image-upload-box');

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    previewContainer.style.display = 'flex';
                    if(uploadBox) { uploadBox.querySelector('.upload-icon').style.display = 'none'; }
                    
                    fileNameSpan.textContent = file.name;
                };
                reader.readAsDataURL(file);
            } else {
                preview.src = '';
                previewContainer.style.display = 'none';
                if(uploadBox) { uploadBox.querySelector('.upload-icon').style.display = ''; }
                fileNameSpan.textContent = '';
                alert('åªèƒ½æ‹–æ”¾å›¾åƒæ–‡ä»¶ (.jpg, .png, etc.)ã€‚');
            }
        }
        
        function createTimelineMarker(rowId, time, percent) {
            const markerDiv = document.createElement('div');
            markerDiv.className = 'timeline-marker';
            markerDiv.style.top = `${percent * 100}%`; 
            markerDiv.setAttribute('data-row-id', rowId);
            
            markers.push({ time: time, rowId: rowId, percent: percent });
            markers.sort((a, b) => a.time - b.time); 

            timelineProgress.appendChild(markerDiv);
        }

        function handleDragStart(e) {
            draggedRow = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML); 
            setTimeout(() => { this.classList.add('dragging'); }, 0);
        }

        function handleDragOver(e) {
            e.preventDefault(); 
            if (this !== draggedRow) { this.classList.add('drag-over'); }
        }
        
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (draggedRow !== this) {
                const rect = this.getBoundingClientRect();
                const offsetY = e.clientY - rect.top;
                
                if (offsetY < rect.height / 2) {
                    tableBody.insertBefore(draggedRow, this);
                } else {
                    tableBody.insertBefore(draggedRow, this.nextSibling);
                }
                updateMarkersAfterSort();
            }
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('tr').forEach(row => row.classList.remove('drag-over'));
            draggedRow = null;
        }

        function updateMarkersAfterSort() {
             const allMarkers = timelineProgress.querySelectorAll('.timeline-marker');
             allMarkers.forEach(markerDiv => {
                 const rowId = markerDiv.getAttribute('data-row-id');
                 if (!document.getElementById(`row-${rowId}`)) {
                     markerDiv.remove();
                     markers = markers.filter(m => m.rowId.toString() !== rowId);
                 }
             });
        }
        
        window.handleImageDragOver = function(e, element) {
            e.preventDefault();
            element.classList.add('drag-target');
            e.dataTransfer.dropEffect = 'copy';
        };

        window.handleImageDragLeave = function(e, element) {
            element.classList.remove('drag-target');
        };

        window.handleImageDrop = function(e, rowId, element) {
            e.preventDefault();
            element.classList.remove('drag-target');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                previewImage(file, rowId);
                
                const fileInput = element.querySelector('input[type="file"]');
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
             resetEditor(true); 
        });
        
    </script>
</body>
</html>
